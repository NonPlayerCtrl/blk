****************************************************************************************************
SEQUENCE STEP SCHEDULE
generated on 10/01/2019 10:05:37 AM by David Paspa
****************************************************************************************************





--------------------------------------------------
SEQUENCE
--------------------------------------------------

Name:- MIX
Title:- PH_EMA1_MIX
Description:- Run Manufacturing Vessel Mx mixer for predefined run time. Log accumulated running time.
Class:- EMA1
Level:- PH
STEP_LIST_FORMAT:- JU    S0@@STEP_NUM@@; // STEP-0@@STEP_NUM@@:
ACT_LIST_FORMAT:- JU    @@ACT_CODE@@@@STEP_NUM@@; //ACTION-@@ACT_NUM@@
HeaderName:- A1_MIX
Version:- 2.0
RevisionHistory:- // SFC Revision History:
// Rev By               Date        CC         Note
// 2.0 David Paspa      27-Nov-2018            Reboot for S7-1500
// 0.5 Khairul Basar    04-Oct-2009 CC-09/023  T002 A(<>I) instruction corrected.
//                                             Accumulative run time loading corrected.
// 0.4 Khairul Basar    11-Sep-2009 CC-09/023  Ref1.
// 0.3 Khairul Basar    25-Aug-2009 CC-09/023  Change in Verific,& TRN code OR to AND
//                                             Change in the Last step.Run timer added.
// 0.2 Khairul Basar    18-Aug-2009            Added logic code
// 0.1 David Paspa      13-Jul-2009            SFC structural design

//Ref1:
//SIC_start_time data type changed from TIME to TOD(TIME_OF_DAY),
//Reset of Timer done on start up.
//In Step2 Dev_state saved & to be compared in the Trans2 well.
HMI_FORMAT:- @@STEP_NUM_INT@@,@@STEP_TITLE@@
SFCCommCode:- 
////Comm from visio


--------------------------------------------------
PARAMETER::1
--------------------------------------------------
Name:- real_setpoint
Type:- REAL
Description:- PH_EMA1_MIX Agiator setpoint log
ParameterInOut:- VAR

--------------------------------------------------
PARAMETER::2
--------------------------------------------------
Name:- log_real_setpoint
Type:- BOOL
Description:- PH_EMA1_MIX Agiator setpoint log
ParameterInOut:- VAR

--------------------------------------------------
PARAMETER::3
--------------------------------------------------
Name:- sic_agit_cmd
Type:- INT
Description:- Agitator command
ParameterInOut:- OUT

--------------------------------------------------
PARAMETER::4
--------------------------------------------------
Name:- log_msg_mix_begin
Type:- BOOL
Description:- PH_EMA1_MIX begin time
ParameterInOut:- VAR

--------------------------------------------------
PARAMETER::5
--------------------------------------------------
Name:- log_msg_mix_end
Type:- BOOL
Description:- PH_EMA1_MIX end time
ParameterInOut:- VAR

--------------------------------------------------
PARAMETER::6
--------------------------------------------------
Name:- setpoint
Type:- REAL
Description:- Required agitator speed for mixing
ParameterInOut:- IN

--------------------------------------------------
PARAMETER::7
--------------------------------------------------
Name:- sic_agit_setpoint
Type:- REAL
Description:- Agitator speed setpoint attribute
ParameterInOut:- OUT

--------------------------------------------------
PARAMETER::8
--------------------------------------------------
Name:- agit_running
Type:- BOOL
Description:- Agitator running
ParameterInOut:- OUT

--------------------------------------------------
PARAMETER::9
--------------------------------------------------
Name:- runtime
Type:- TIME
Description:- Agitator run time
ParameterInOut:- IN

--------------------------------------------------
PARAMETER::10
--------------------------------------------------
Name:- AcumTimeS
Type:- INT
Description:- AcumTimeS
ParameterInOut:- OUT

--------------------------------------------------
PARAMETER::11
--------------------------------------------------
Name:- AcumTimeM
Type:- INT
Description:- AcumTimeM
ParameterInOut:- OUT

--------------------------------------------------
PARAMETER::12
--------------------------------------------------
Name:- AcumTimeH
Type:- INT
Description:- Total acumulated running time
ParameterInOut:- OUT

--------------------------------------------------
PARAMETER::13
--------------------------------------------------
Name:- agit_hist
Type:- INT
Description:- Previous state of SIC 
ParameterInOut:- VAR

--------------------------------------------------
PARAMETER::14
--------------------------------------------------
Name:- agit_stopped
Type:- BOOL
Description:- Agitator stopped message to be logged
ParameterInOut:- OUT

--------------------------------------------------
PARAMETER::15
--------------------------------------------------
Name:- sic_agit_state
Type:- INT
Description:- Agitator state 
ParameterInOut:- IN


--------------------------------------------------
STEP::01
--------------------------------------------------
StepNo:- 01
Title:- PH_EMA1_MIX : SIC Running
Description:- Log EMA1_MIX begin time.
Initialise the run timer.

--------------------------------------------------
ACTION::01
--------------------------------------------------
Description:- Log EMA1_MIX begin time.
Initialise the run timer.
Action:- //Log EMA1_MIX begin time.
SET;
S #_log_msg_mix_begin;

// Set the agitator speed setpoint
L #_setpoint;
T #_sic_agit_setpoint;
T #_real_setpoint;

SET;
S #_log_real_setpoint;


//Start Timer for agitator runtime
A #SQ_TIMER.Q;
R #sqSeqTimerStart;

AN #SQ_TIMER.Q;
S #sqSeqTimerStart;
L #_runtime;
T #SQ_TIMER.PT;

// Mixer is running so start accumulating the run time.
S #sqRunTimer.ENABLE;

L "dbCONST".BLK.SIC1.CMD.ENABLE;
T #_sic_agit_cmd;

//The  mixer is now be running. 
L "dbCONST".BLK.SIC1.STATE.RUNNING;
T #_agit_hist;
Verification:- A #sqSeqTimerStart;


--------------------------------------------------
TRANSITION::01
--------------------------------------------------
TRNNo:- 01
Title:- Unconditional Jump
EmptyTransition:- False
Description:- Jump
Condition:- A "uncondJump";


--------------------------------------------------
STEP::02
--------------------------------------------------
StepNo:- 02
Title:- PH_EMA1_MIX : Wait for state change
Description:- Wait for state change

--------------------------------------------------
ACTION::01
--------------------------------------------------
Description:- Make sure the timer is not being reset
Action:- // Make sure the timer is not being reset
SET;
R #sqRunTimer.RESET;
R #sqRunTimer.NON_RET;
S #sqRunTimer.ENABLE;
Verification:- A "uncondJump";


--------------------------------------------------
TRANSITION::02
--------------------------------------------------
TRNNo:- 02
Title:- TIME_RUN expired
EmptyTransition:- False
Description:- Jump if running time has expired
Condition:- A #SQ_TIMER.Q;


--------------------------------------------------
TRANSITION::03
--------------------------------------------------
TRNNo:- 03
Title:- Change of SIC State
EmptyTransition:- False
Description:- SIC State Changed.
SIC not running.
Condition:- //Check whether the last SIC state is not equal to current state
A(;
L #_agit_hist;
L #_sic_agit_state;
<>I;
);
//SIC not running.
A(;
L "dbCONST".BLK.SIC1.STATE.RUNNING;
L #_sic_agit_state;
<>I;
);


--------------------------------------------------
TRANSITION::04
--------------------------------------------------
TRNNo:- 04
Title:- Change of SIC State
EmptyTransition:- False
Description:- SIC State Changed.
SIC running.
Condition:- //Check whether the last SIC state is not equal to current state
A(;
L #_agit_hist;
L #_sic_agit_state;
<>I;
);
//SIC running.
A(;
L "dbCONST".BLK.SIC1.STATE.RUNNING;
L #_sic_agit_state;
==I;
);


--------------------------------------------------
STEP::03
--------------------------------------------------
StepNo:- 03
Title:- PH_EMA1_MIX : SIC State Changed to Stop
Description:- Stop the timer, report accumulative total running time and Save the previous state of the mixer..

--------------------------------------------------
ACTION::01
--------------------------------------------------
Description:- Stop the timer, report accumulative total running time and Save the previous state of the mixer.
Action:- // Mixer is currently not running
// Stop the timer
R #sqRunTimer.ENABLE;

R #_agit_running;
S #_agit_stopped;

//Report accumulative total running time
   CALL  fcTime2HMS(
       TIM_VAL:=#sqRunTimer.RetElapsedTime,
       H      :=#_AcumTimeH,
       M      :=#_AcumTimeM,
       S      :=#_AcumTimeS);
      NOP   0;


// Save the previous run or stopped state of the mixer
L #_sic_agit_state;
T #_agit_hist;
Verification:- A "uncondJump";


--------------------------------------------------
TRANSITION::05
--------------------------------------------------
TRNNo:- 05
Title:- Unconditional Jump
EmptyTransition:- False
Description:- Jump
Condition:- A "uncondJump";


--------------------------------------------------
STEP::04
--------------------------------------------------
StepNo:- 04
Title:- PH_EMA1_MIX : SIC State Changed to Run
Description:- Run the timer, report accumulative total running time and Save the previous state of the mixer.

--------------------------------------------------
ACTION::01
--------------------------------------------------
Description:- Run the timer, report accumulative total running time and Save the previous state of the mixer.
Action:- // Mixer is running again so start the run timer.
S #sqRunTimer.ENABLE;

S #_agit_running;
R #_agit_stopped;

// Save the previous state of the mixer
L #_sic_agit_state;
T #_agit_hist;
Verification:- A "uncondJump";



--------------------------------------------------
TRANSITION::06
--------------------------------------------------
TRNNo:- 06
Title:- Unconditional Jump
EmptyTransition:- False
Description:- Jump
Condition:- A "uncondJump";


--------------------------------------------------
STEP::05
--------------------------------------------------
StepNo:- 05
Title:- PH_EMA1_MIX : Disable SIC
Description:- Disable SIC.

--------------------------------------------------
ACTION::01
--------------------------------------------------
Description:- Disable SIC.
Action:- L "dbCONST".BLK.SIC1.CMD.DISABLE;
T #_sic_agit_cmd;
Verification:- A "uncondJump";


--------------------------------------------------
TRANSITION::07
--------------------------------------------------
TRNNo:- 07
Title:- SIC Disabled
EmptyTransition:- False
Description:- Jump
Condition:- //Proceed to next step if SIC has been disabled
A(;
L "dbCONST".BLK.SIC1.STATE.DISABLED;
L #_sic_agit_state;
==I;
);


--------------------------------------------------
STEP::06
--------------------------------------------------
StepNo:- 06
Title:- PH_EMA1_MIX : Last Step
Description:- Reset the timer, store current SIC state and report the event.
Log EMA1_MIX end time.

--------------------------------------------------
ACTION::01
--------------------------------------------------
Description:- Reset the timer, store current SIC state and report the event.
Log EMA1_MIX end time.
Action:- //Store current SIC state.
L #_sic_agit_state;
T #_agit_hist;

S #sqRunTimer.RESET;
//Set timer ON delay.
R #sqRunTimer.ENABLE;

   CALL  fcTime2HMS(
       TIM_VAL:=#sqRunTimer.RetElapsedTime,
       H      :=#_AcumTimeH,
       M      :=#_AcumTimeM,
       S      :=#_AcumTimeS);
      NOP   0;

//Log EMA1_MIX end time.
SET;
S #_log_msg_mix_end;
Verification:- A "uncondJump";


****************************************************************************************************
END SSS REPORT
****************************************************************************************************
